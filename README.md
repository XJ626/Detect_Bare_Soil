# Detect Bare Soil pixel in China
The code is for detecting the bare soil pixels using time-series images
## Background
Accurate and detailed spatial–temporal soil information is crucial for soil quality assessment worldwide, particularly in the countries with large populations and extensive agricultural areas. Using remote sensing technology to generate bare soil reflectance composites has been shown as a prerequisite for effectively modeling soil properties. However, most bare soil extraction methods rely on the single-period satellite imagery, making it difficult to produce a complete bare soil map. Although some developed methods have explored the advantages of multitemporal images, single indicators (e.g., Normalized Difference Vegetation Index and Normalized Burn Ratio 2) are prone to misidentifying bare soil as other land cover types such as impervious surface. Additionally, these methodologies were designed for specific areas and coarse spatial resolution images, leaving their generalizability to other areas or larger scales underexplored.
## Main idea
We proposed a Two-Dimensional Bare Soil Separation (TDBSS) framework to generate the bare soil composites of Chinese cropland at 10-m spatial resolution using multi-temporal Sentinel-2 images. This method employs the Normalized Difference Red/Green Redness Index and Soil Adjusted Vegetation Index as bidimensional indicators. We identified optimal thresholds for these indicators by analyzing ecoregion-specific samples and then implemented them across nine major agricultural zones in China. Additionally, we evaluated the framework against three prevalent bare soil extraction methods (i.e., Barest Pixel Composite, Soil Composite Mapping Processor, and Geospatial Soil Sensing System) based on spatial accuracy. 
## Main framework
This study aims to: (1) propose an effective method to distinguish vegetation (i.e., photosynthetically active areas of cropland, the same below), straw, and impervious surface from bare soil
by separating hidden information in two-dimensional space and determining thresholds with the confidence ellipse method, and generate a continuous bare soil map over China at 10-m spatial resolution; (2) make a comprehensive evaluation on three prevalent bare soil extraction algorithms (BPC, SCMaP and GEOS3) for their areal and spatial accuracy. The main process is as follows.
                                                      ![image](https://github.com/user-attachments/assets/f1903f50-6f8b-4507-82b2-fe4dcdd79648)
                                                                  Fig.1 The main workflow of TDBSS method and this study.
                                                                  
### Sentinel-2 image acquisition and treatments
Sentinel-2 Multi-Spectral Imager constellation includes two satellite sensors (2A and 2B), with a five-day revisiting period. It provides 13 spectral bands with different spatial resolution at 10 m, 20 m or 60 m. For the study area, the Level-2A products during the period from 1 January 2018 to 31 December 2022 were downloaded via Google Earth Engine. These products have been geometrically and radiometrically corrected. To acquire the high-quality images, the QA band was applied remove clouds and cirrus furtherly. Finally, we obtained the available cloud-free Sentinel-2 images, presenting an escalating pattern from the south towards the north. The six bands were used in this study for both the creation of true color composites and the calculation of various indices, covering the visible (B2-B4), NIR (B8), and SWIR (B11, B12) regions. All the bands were resampled to a 10-m spatial resolution using the bilinear method and projected into the WGS84 Geographic Latitude-Longitude system.
                                                      ![image](https://github.com/user-attachments/assets/c4b399b6-5b85-496f-93e0-320ae161a85c)
                                                    Fig.2 The image count of Sentinel-2 scenes used in the per pixel compositing for this study.
                                                    
### Geospatial soil sensing System
Geospatial Soil Sensing System (GEOS3) is a soil spectral reflectance extraction method proposed by Dematte et al. (2018), the procedure is as follows. The first step is to establish a time-series database of Sentinel-2 images from 2018 to 2022. Secondly, the database is filtered to remove pixels containing vegetation, straw, water, and other land covers that are not bare soil from each satellite image. The set of rules for this step was defined as follows: the Normalized Difference Vegetation Index (NDVI) was used to distinguish vegetation from bare soil areas and the spectral mixture of soil and vegetation due to the significant difference in values between them. According to the study by Dematte et al. (2018), we set the NDVI value between 0 and 0.25 as the threshold for soil, while the value for vegetation was greater than 0.25. Meanwhile, discriminating straw from soils in satellite images was achieved using the 0.15 threshold for Normalized Burn Ratio 2 (NBR2) (Dematte et al., 2018). To improve soil masking, the difference between B4 and B3, as well as between B3 and B2 were also calculated. The third step is to calculate the spectral reflectance for each soil pixel over the time series. Finally, the spectral reflectance for each soil pixel is filtered by the median value, composing a continuous soil spectral reflectance map.
### Soil Composite mapping Processor
Soil Composite Mapping Processor (SCMaP) is an approach aiming to build per-pixel bare soil composites, proposed by Rogge et al. (2018). It primarily uses NDVI to distinguish bare soil (low NDVI) and photosynthetically active vegetation (PV, high NDVI) in agricultural areas. The first step involves building PV maximum and minimum composites. To mitigate the effects of increased reflectance caused by thin haze, a modified NDVI is used, incorporating the blue channel in the second normalized difference index. The second step is determining thresholds. Rogge et al. (2018) tested a series of thresholds across six LULC types: deciduous, coniferous, fields, grassland, urban, and water. To better separate these LULC types from bare soil, threshold values of Hmin and Hmax were generated based on PVmin and PVmax values. The final step involves generating the bare soil map. The Hmax threshold is applied to the PVmax image to create the A mask, while the Hmin threshold is used on the PVmin image to create the B mask. The intersection of these two masks produces the bare soil images.
### Barest pixel Composite
Bare Soil Index (BSI) can be used to differentiate bare soil from other land cover types. Diek et al. (2017) utilized this index to develop the Barest-Pixel Composite (BPC). The BSI values range from −1 to 1, representing changes in bare soil presence from low to high. Pixels with a BSI value above 0.021 were classified as bare soil. The BPC map was generated by calculating the median value for each pixel (Diek et al., 2017).
### Two-dimensional bare soil separation algorithm
We proposed a new framework for improving bare soil extraction, named the Two-Dimensional Bare Soil Separation (TDBSS) algorithm. To achieve this, the Soil Adjusted Vegetation Index (SAVI) and Normalized Difference Red/Green Redness Index (NDRGI) were introduced in this study. SAVI is a vegetation index designed to address the limitations of NDVI, which does not account for soil luminance. NDRGI is another vegetation index, highly responsive to various ground covers. Identifying appropriate thresholds for these indicators is crucial for detecting bare soil. First, two-dimensional indicator scatter plots were generated for each agricultural area. Confidence ellipses were then created for the scatter plot distributions of each LULC type using density analysis. This approach effectively distinguished vegetation from bare soil pixels. However, some overlap occurred between bare soil and impervious surface pixels. To address this, the Parallelepiped classification method was introduced. Ellipses for these two LULC types were adjusted to be as tangential as possible using different confidence intervals. These adjustments were conducted in RStudio using the ggplot2 package and the stat_ellipse function with a t-distribution. Finally, tangent lines were drawn from the left and lower edges of the bare soil ellipse, and the NDRGI and SAVI thresholds were determined as values greater than the intersection of these lines. To minimize straw interference and improve soil masking, we adopted measures from Demattê et al. (2018), including NBR2 < 0.15, B3 − B2 > 0, and B4 − B3 > 0. Additionally, a water body detection method was introduced to identify and eliminate open surface water near croplands. Open water was identified using the following criteria: EVI < 0.1 and either mNDWI > NDVI or mNDWI > EVI (Zou et al., 2017). Finally, the spectral reflectance of each soil pixel was composited using a median value filter, resulting in a continuous composite map of bare soil spectral reflectance. 

## Main result
We introduced a novel framework, TDBSS, specifically designed for bare soil extraction using extended time series Sentinel-2 images. Its performance was compared against three widely-used bare soil extraction methods: BPC, SCMaP, and GEOS3. In terms of spatial accuracy, TDBSS outperformed the other methods, achieving an overall accuracy (OA) of 78.28%. This demonstrates that the TDBSS algorithm effectively distinguishes crops and impervious surfaces from bare soil. Additionally, the NBR2 index proved valuable in separating soil from straw, further enhancing the algorithm's efficacy.
![image](https://github.com/user-attachments/assets/2ea9616d-1a90-43bf-a5cc-ae37b6c949e6)
Fig.3 True color RGB 321 of the bare soil spatial patterns by four extraction methods. 

![image](https://github.com/user-attachments/assets/7abf83f5-c15c-420b-9871-3008a44a7673)
Fig.4 The spatial agreement between bare soil map and cropland dataset. 


## Reference:
[1] Xue J, Zhang X, Huang Y, et al. A two-dimensional bare soil separation framework using multi-temporal Sentinel-2 images across China[J]. International Journal of Applied Earth Observation and Geoinformation, 2024, 134: 104181.

[2] Demattê J A M, Fongaro C T, Rizzo R, et al. Geospatial Soil Sensing System (GEOS3): A powerful data mining procedure to retrieve soil spectral reflectance from satellite images[J]. Remote Sensing of Environment, 2018, 212: 161-175.

[3] Demattê J A M, Safanelli J L, Poppiel R R, et al. Bare earth’s surface spectra as a proxy for soil resource monitoring[J]. Scientific reports, 2020, 10(1): 4461.

[4] Diek S, Fornallaz F, Schaepman M E, et al. Barest pixel composite for agricultural areas using landsat time series[J]. Remote Sensing, 2017, 9(12): 1245.

[5] Sorenson P T, Shirtliffe S J, Bedard-Haughn A K. Predictive soil mapping using historic bare soil composite imagery and legacy soil survey data[J]. Geoderma, 2021, 401: 115316.

[6] Rogge D, Bauer A, Zeidler J, et al. Building an exposed soil composite processor (SCMaP) for mapping spatial and temporal characteristics of soils with Landsat imagery (1984–2014)[J]. Remote Sensing of Environment, 2018, 205: 1-17.

[7] Zou Z, Dong J, Menarguez M A, et al. Continued decrease of open surface water body area in Oklahoma during 1984–2015[J]. Science of the Total Environment, 2017, 595: 451-460.

## Contact
Dr. Jie Xue, Zhejiang Univerisity, E-mail: xj2019@zju.edu.cn;

Prof. Zhou Shi, Zhejiang Univerisity, E-mail: shizhou@zju.edu.cn.


